<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-latest.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal/js/jquery.terminal.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/jquery.terminal/css/jquery.terminal.min.css" rel="stylesheet"/>
    <script src="https://pyodide.cdn.iodide.io/pyodide.js"></script>
  </head>
  <body>
    <script>
      'use strict';
      let DEBUG = true;  // Log some debug stuff if true
      let DEDENT_ON_PASTE = true;  // If true, dedent text when pasting. 
      let RUNNING = false;  // Wait for RUNNING==false before allowing next console prompt.
      var TRY_RUN = true;  // If false the buffer will not be executed when pressing enter.
      let REDIRECTCONSOLE = false;  // True to redirect console log/error to terminal.

      let __delay__ = (ms) => new Promise(resolve => setTimeout(resolve, ms));

      var loadPackageFlagged = function(packageName) {
          // Load package into virtual filesystem and flag to console
          // that code is running.
          RUNNING = true;
          REDIRECTCONSOLE = true;  // Display info/errors for user.
          pyodide.loadPackage(packageName).then(
              (r) => {
                  RUNNING = false;
                  REDIRECTCONSOLE = false;
                  term.echoRaw(r);
              }, 
              (r) => {
                  RUNNING = false;
                  REDIRECTCONSOLE = false;
                  term.error(r);
              }
          );
      };

      (function(){
            // Override console.log and console.error to add terminal echo/error to it.
            // https://stackoverflow.com/a/11403146/8899565
            let oldLog = console.log;
            let oldError = console.error;
            console.log = function (message) {
                if (REDIRECTCONSOLE) {term.echoRaw(message)}
                oldLog.apply(console, arguments);
            };
            console.error = function (message) {
                if (REDIRECTCONSOLE) {term.error(message)}
                oldError.apply(console, arguments);
            };
      })();

      languagePluginLoader.then(() => {
        async function pushCode(line) {
            pyodide.globals._push(line);
            while (RUNNING) {await __delay__(1)}  // Wait for running to finish.
            TRY_RUN = true;  // Default back to true.
        }

        let shift_enter = function() {
            // pushLineNoRun()
            TRY_RUN = false;
            let cmd = term.get_command();
            term.set_command('');
            term.history().append(cmd);
            term.exec(cmd, false)
        };

        var term = $('body').terminal(
          pushCode,
          {
            greetings: "Welcome to the Pyodide terminal emulator 🐍",
            prompt: "[[;grey;]>>> ]",
            exceptionHandler: (e) => {
                console.log(e.message);
                console.log(e.stack);
                term.error(e.message);
            },
            keymap: {
                "SHIFT+ENTER": shift_enter,
                "BACKSPACE": (e, orig) => {
                    // Allow backspace to remove a line.
                    let cmd = term.get_command();
                    if (cmd.length > 0) {
                        orig();  // Normal backspace if there are characters.
                    } else {
                        let buffer_len = pyodide.runPython('len(_buffer)');
                        if (buffer_len == 0) {return};
                        term.remove_line(-1);
                        let new_cmd = pyodide.runPython('_buffer.pop()');
                        term.set_command(new_cmd)
                        if (buffer_len == 1) {
                            term.set_prompt('[[;gray;]>>> ]');
                        }
                    }
                },
                "CTRL+C": (e, orig) => {
                    // Cancel current input.
                    let cmd = term.get_command();
                    term.insert('^C');
                    let cancelled_line = term.get_prompt() + term.get_command();
                    if (cmd.trim().length > 0){
                        term.history().append(term.get_command());
                    }
                    pyodide.runPython('_buffer.clear()');
                    term.set_command('');
                    term.exec('', false);
                    term.updateRaw(-1, cancelled_line);
                    console.log(cancelled_line)
                }
            }
          }
        );

        term.bind("paste", function(e){
            // Paste text in terminal as though shift + enter was used.
            // TODO: handle pasting in the middle of a line.
            e = e.originalEvent;
            if (e.clipboardData.getData) {
                let text = e.clipboardData.getData('text/plain');
                if (DEDENT_ON_PASTE) {
                    text = pyodide.globals.textwrap.dedent(text);
                }
                let lines = text.split("\n");
                lines.forEach( (line, i) => {
                    term.insert(line);
                    if (i != lines.length - 1) {  //  Don't return on last line.
                        shift_enter();
                    }
                })
            }
            return false; // Don't run other paste events :)
        });

        term.echoRaw = function(line) {
            line = $.terminal.escape_brackets(line);
            term.echo(line);
        };

        term.updateRaw = function(lineno, line) {
            line = $.terminal.escape_brackets(line);
            term.update(lineno, line);
        };

        window.term = term;
        pyodide.runPython(String.raw`
        import io
        import code
        import sys
        import traceback
        import textwrap
        from js import term, pyodide as pyodidejs, console
        import pyodide
        import js
        
        _buffer = []

        class _StringIORedirect(io.StringIO):
            """ StringIO, but everything is echoed to the terminal.
            Since while python code is running the browser UI is blocked 
            (does not re-render), calling term.echo every time data is written
            is no different to calling term.echo once after the code
            has been executed with all the data.
            Hence the use of the flush() function instead of incrementally
            calling term.echo().
            """
            def __init__(self, *args, **kwargs):
                self.line_buffer = ''
                super().__init__(*args, **kwargs)
            def write(self, *args, **kwargs):
                # super().write(*args, **kwargs)
                self.line_buffer += args[0]
            def display(self):
                if self.line_buffer:
                    term.echoRaw(self.line_buffer)
            def clear(self):
                self.line_buffer = ''

        
        _out = sys.stdout = sys.stderr = _StringIORedirect()

        def _push(line):
            """Add line of code to buffer and execute it if ready."""
            _buffer.append(line)
            
            if js.TRY_RUN:
                # Always exec if final line is whitespace.
                if line.split('\n')[-1].strip() == "":
                    return _exec_buffer()
                
                # Exec on single line input 
                if len(_buffer) == 1:
                    try:
                        if code.compile_command(line):
                            return _exec_buffer()
                    except (OverflowError, SyntaxError, ValueError):
                        pass  # Allow these to occur when the user executes the code.

            # More input expected, set prompt accordingly.
            term.set_prompt('[[;gray;]... ]')
            if line and line.strip()[-1] == ':':
                term.insert('    ')


        def _exec_buffer():
            """ Execute and clear the buffer. """
            _out.clear()
            code_str = "\n".join(_buffer)
            display = len(_buffer)==1  # Only display if code is a single line.
            _buffer.clear()
            term.set_prompt('[[;grey;]>>> ]')
            try:
                res = pyodide.eval_code(code_str, globals())
            except Exception as e:
                res = None
                print(traceback.format_exc(), file=sys.stderr, end='')
            if display and res is not None:
                print(repr(res), end='')
            _out.display()
        `)
        
        /*
        term.exec('')
        term.exec('# To import a python package you must:')
        term.exec('#     1. Load the files into the virtual filesystem')
        term.exec('#     2. import the package like normal')
        term.exec('')
        term.exec('js.loadPackageFlagged("numpy")  # Load the files into the virtual filesystem')
        term.exec('import numpy as np  # import it as normal')
        term.exec('')
        term.exec('a = np.array([1, 2, 3])')
        term.exec('a')
        term.exec('print(a)')
        */
        
      });
    </script>
  </body>
</html>
