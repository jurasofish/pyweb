<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-latest.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal/js/jquery.terminal.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/jquery.terminal/css/jquery.terminal.min.css" rel="stylesheet"/>
    <link href="renderedhtml.css" rel="stylesheet"/>
    <script src="https://pyodide.cdn.iodide.io/pyodide.js"></script>
  </head>
  <body>
    <script>
      let DEBUG = true;
      languagePluginLoader.then(() => {
        function pushCode(line) {
            push(line)
        }

        var term = $('body').terminal(
          pushCode,
          {
            greetings: "Welcome to the Pyodide terminal emulator ðŸ",
            prompt: "[[;grey;]>>> ]"
          }
        );

        window.term = term;
        pyodide.runPython(String.raw`
        import io, code, sys
        from js import term, pyodide
        
        buffer = []

        class StringIORedirect(io.StringIO):
            """ StringIO, but everything is echoed to the terminal."""
            def write(self, *args, **kwargs):
                # super().write(*args, **kwargs)
                term.echo(args[0])
        
        sys.stdout = StringIORedirect()
        sys.stderr = StringIORedirect()

        def _push(line):
            """Add line of code to buffer and execute it if ready."""
            buffer.append(line)
            
            # Always exec if final line is blank.
            if line == "":
                return exec_buffer()
            
            # Exec on single line input 
            if len(buffer) == 1:
                try:
                    if code.compile_command(line):
                        return exec_buffer()
                except (OverflowError, SyntaxError, ValueError):
                    pass  # Allow these to occur when the user executes the code.

            # More input expected, set prompt accordingly.
            term.set_prompt('[[;gray;]... ]')


        def exec_buffer():
            """ Execute and clear the buffer. """
            code_str = "\n".join(buffer)
            display = len(buffer)==1  # Only display if code is a single line.
            buffer.clear()
            term.set_prompt('[[;grey;]>>> ]')
            term.runPython(code_str, display)
        `)

        var push = pyodide.pyimport('_push')

        term.runPython = function(code, display) {
          if(DEBUG) {console.log(code)};
          pyodide.runPythonAsync(code).then(
            (r) => term.displayExpressionResult(r, display), term.handlePythonError
          )
        }
        
        term.displayExpressionResult = function(result, display) {
          if (display) {
            if (result === undefined) {
                    return
                } else if (result['_repr_html_'] !== undefined) {
                    term.echo(result['_repr_html_'], {raw: true})
                } else {
                    term.echo(result.toString())
            }
          }
        }

        term.handlePythonError = function(result) {
          term.error(result.toString())
        }
        
        // automate input to terminal:
        // term.exec("print(1)", false)
      });
    </script>
  </body>
</html>
